<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åˆ†é¡æª¢è¦–åŠŸèƒ½æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .category-item:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .debug-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        .test-result {
            margin: 0.5rem 0;
            padding: 0.5rem;
            border-radius: 4px;
        }
        .test-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1><i class="fas fa-bug me-2"></i>æ™ºèƒ½åˆ†é¡æª¢è¦–åŠŸèƒ½æ¸¬è©¦</h1>
        
        <!-- æ¸¬è©¦é¢æ¿ -->
        <div class="debug-panel">
            <h3>ğŸ”§ åŠŸèƒ½æ¸¬è©¦é¢æ¿</h3>
            <div class="row">
                <div class="col-md-6">
                    <button class="btn btn-primary" onclick="testCategoryStatsAPI()">æ¸¬è©¦åˆ†é¡çµ±è¨ˆAPI</button>
                    <button class="btn btn-secondary ms-2" onclick="testCategoryNewsAPI()">æ¸¬è©¦åˆ†é¡æ–°èAPI</button>
                </div>
                <div class="col-md-6">
                    <button class="btn btn-success" onclick="testSelectAllFunction()">æ¸¬è©¦å…¨é¸åŠŸèƒ½</button>
                    <button class="btn btn-warning ms-2" onclick="testCategoryClick()">æ¸¬è©¦åˆ†é¡é»æ“Š</button>
                </div>
            </div>
            <div id="testResults" class="mt-3"></div>
        </div>
        
        <!-- æ™ºèƒ½åˆ†é¡æª¢è¦–æ¨¡æ“¬ -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-brain text-info me-2"></i>æ™ºèƒ½åˆ†é¡æª¢è¦–</h3>
            </div>
        </div>

        <div class="row mb-4" id="categoryStatsContainer">
            <div class="col-md-4">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-heart me-2"></i>å®¢æˆ¶é—œæ³¨</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="ç†è³ æ¡ˆä¾‹">
                                ç†è³ æ¡ˆä¾‹ <span class="badge bg-danger" id="count-ç†è³ æ¡ˆä¾‹">è¼‰å…¥ä¸­...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="ä¿è²»èª¿æ•´">
                                ä¿è²»èª¿æ•´ <span class="badge bg-warning" id="count-ä¿è²»èª¿æ•´">è¼‰å…¥ä¸­...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="æ³•è¦è®Šå‹•">
                                æ³•è¦è®Šå‹• <span class="badge bg-info" id="count-æ³•è¦è®Šå‹•">è¼‰å…¥ä¸­...</span>
                            </li>
                        </ul>
                        <button class="btn btn-primary btn-sm mt-2 w-100 view-all-btn" data-group="å®¢æˆ¶é—œæ³¨">æŸ¥çœ‹å…¨éƒ¨</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fas fa-building me-2"></i>å…¬å¸å‹•æ…‹</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="æ–°å•†å“ç™¼å¸ƒ">
                                æ–°å•†å“ç™¼å¸ƒ <span class="badge bg-success" id="count-æ–°å•†å“ç™¼å¸ƒ">è¼‰å…¥ä¸­...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="é€šè·¯æ”¿ç­–">
                                é€šè·¯æ”¿ç­– <span class="badge bg-primary" id="count-é€šè·¯æ”¿ç­–">è¼‰å…¥ä¸­...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="ç²çæ¶ˆæ¯">
                                ç²çæ¶ˆæ¯ <span class="badge bg-warning" id="count-ç²çæ¶ˆæ¯">è¼‰å…¥ä¸­...</span>
                            </li>
                        </ul>
                        <button class="btn btn-success btn-sm mt-2 w-100 view-all-btn" data-group="å…¬å¸å‹•æ…‹">æŸ¥çœ‹å…¨éƒ¨</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>å¸‚å ´åˆ†æ</h6>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="ä¿è²»è¶¨å‹¢">
                                ä¿è²»è¶¨å‹¢ <span class="badge bg-info" id="count-ä¿è²»è¶¨å‹¢">è¼‰å…¥ä¸­...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="ç«¶çˆ­åˆ†æ">
                                ç«¶çˆ­åˆ†æ <span class="badge bg-secondary" id="count-ç«¶çˆ­åˆ†æ">è¼‰å…¥ä¸­...</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between category-item" data-category="å®¢ç¾¤è®ŠåŒ–">
                                å®¢ç¾¤è®ŠåŒ– <span class="badge bg-dark" id="count-å®¢ç¾¤è®ŠåŒ–">è¼‰å…¥ä¸­...</span>
                            </li>
                        </ul>
                        <button class="btn btn-info btn-sm mt-2 w-100 view-all-btn" data-group="å¸‚å ´åˆ†æ">æŸ¥çœ‹å…¨éƒ¨</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å„ªå…ˆé—œæ³¨æ–°èå€åŸŸ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-fire me-2"></i>å„ªå…ˆé—œæ³¨æ–°è</h5>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label text-white" for="selectAll">å…¨é¸</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="newsList">
                        <div class="text-center py-4">
                            <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                            <p class="text-muted">é»æ“Šä¸Šæ–¹åˆ†é¡é …ç›®è¼‰å…¥æ–°è</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
    <div id="loadingSpinner" class="position-fixed top-50 start-50 translate-middle d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ç°¡åŒ–ç‰ˆæ¸¬è©¦å‡½æ•¸
        
        function addTestResult(message, success = true) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${success ? 'test-success' : 'test-error'}`;
            div.innerHTML = `<i class="fas fa-${success ? 'check' : 'times'} me-2"></i>${message}`;
            results.appendChild(div);
        }
        
        async function testCategoryStatsAPI() {
            try {
                const response = await fetch('/business/api/category-stats');
                const data = await response.json();
                
                if (data.status === 'success') {
                    addTestResult('âœ… åˆ†é¡çµ±è¨ˆAPIæ­£å¸¸å·¥ä½œ', true);
                    updateCategoryStatsDisplay(data.stats);
                } else {
                    addTestResult('âŒ åˆ†é¡çµ±è¨ˆAPIå›å‚³éŒ¯èª¤', false);
                }
            } catch (error) {
                addTestResult(`âŒ åˆ†é¡çµ±è¨ˆAPIè«‹æ±‚å¤±æ•—: ${error.message}`, false);
            }
        }
        
        async function testCategoryNewsAPI() {
            try {
                const response = await fetch('/business/api/category-news?group=å®¢æˆ¶é—œæ³¨&category=ä¿è²»èª¿æ•´');
                const data = await response.json();
                
                if (data.status === 'success') {
                    addTestResult(`âœ… åˆ†é¡æ–°èAPIæ­£å¸¸å·¥ä½œï¼Œè¿”å›${data.count}æ¢æ–°è`, true);
                } else {
                    addTestResult('âŒ åˆ†é¡æ–°èAPIå›å‚³éŒ¯èª¤', false);
                }
            } catch (error) {
                addTestResult(`âŒ åˆ†é¡æ–°èAPIè«‹æ±‚å¤±æ•—: ${error.message}`, false);
            }
        }
        
        function testSelectAllFunction() {
            const selectAllBtn = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.news-select');
            
            if (selectAllBtn) {
                // æ¨¡æ“¬é»æ“Šå…¨é¸
                selectAllBtn.checked = true;
                selectAllBtn.dispatchEvent(new Event('change'));
                
                const checkedBoxes = document.querySelectorAll('.news-select:checked');
                if (checkedBoxes.length === checkboxes.length) {
                    addTestResult('âœ… å…¨é¸åŠŸèƒ½æ­£å¸¸å·¥ä½œ', true);
                } else {
                    addTestResult('âŒ å…¨é¸åŠŸèƒ½ç„¡æ³•æ­£å¸¸é¸å–æ‰€æœ‰é …ç›®', false);
                }
            } else {
                addTestResult('âŒ æ‰¾ä¸åˆ°å…¨é¸æŒ‰éˆ•', false);
            }
        }
        
        function testCategoryClick() {
            const categoryItem = document.querySelector('.category-item[data-category="ä¿è²»èª¿æ•´"]');
            if (categoryItem) {
                categoryItem.click();
                addTestResult('âœ… åˆ†é¡é …ç›®é»æ“Šäº‹ä»¶å·²è§¸ç™¼', true);
            } else {
                addTestResult('âŒ æ‰¾ä¸åˆ°åˆ†é¡é …ç›®', false);
            }
        }
        
        function updateCategoryStatsDisplay(stats) {
            for (const [group, categories] of Object.entries(stats)) {
                for (const [category, count] of Object.entries(categories)) {
                    const countElement = document.getElementById(`count-${category}`);
                    if (countElement) {
                        countElement.textContent = count;
                        // æ ¹æ“šæ•¸é‡è¨­ç½®ä¸åŒçš„æ¨£å¼
                        if (count > 5) {
                            countElement.className = 'badge bg-danger';
                        } else if (count > 2) {
                            countElement.className = 'badge bg-warning';
                        } else if (count > 0) {
                            countElement.className = 'badge bg-info';
                        } else {
                            countElement.className = 'badge bg-secondary';
                        }
                    }
                }
            }
        }
        
        // åˆå§‹åŒ–åˆ†é¡é»æ“Šäº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const categoryItems = document.querySelectorAll('.category-item');
            const viewAllButtons = document.querySelectorAll('.view-all-btn');
            
            categoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    const group = this.closest('.card').querySelector('.card-header h6').textContent.trim();
                    
                    loadCategoryNews(group, category);
                });
            });
            
            viewAllButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const group = this.getAttribute('data-group');
                    loadCategoryGroupNews(group);
                });
            });
            
            // å…¨é¸åŠŸèƒ½
            const selectAllBtn = document.getElementById('selectAll');
            if (selectAllBtn) {
                selectAllBtn.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.news-select');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
            }
            
            // è‡ªå‹•è¼‰å…¥çµ±è¨ˆæ•¸æ“š
            testCategoryStatsAPI();
        });
        
        async function loadCategoryNews(group, category) {
            document.getElementById('loadingSpinner').classList.remove('d-none');
            
            try {
                const response = await fetch(`/business/api/category-news?group=${encodeURIComponent(group)}&category=${encodeURIComponent(category)}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateNewsList(data.news, `${group}: ${category}`, data.count);
                    addTestResult(`âœ… è¼‰å…¥ã€Œ${category}ã€æ–°èæˆåŠŸï¼Œå…±${data.count}æ¢`, true);
                } else {
                    addTestResult(`âŒ è¼‰å…¥ã€Œ${category}ã€æ–°èå¤±æ•—`, false);
                }
            } catch (error) {
                addTestResult(`âŒ è¼‰å…¥æ–°èå¤±æ•—: ${error.message}`, false);
            } finally {
                document.getElementById('loadingSpinner').classList.add('d-none');
            }
        }
        
        async function loadCategoryGroupNews(group) {
            document.getElementById('loadingSpinner').classList.remove('d-none');
            
            try {
                const response = await fetch(`/business/api/category-group?group=${encodeURIComponent(group)}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateNewsList(data.news, group, data.news.length);
                    addTestResult(`âœ… è¼‰å…¥ã€Œ${group}ã€åˆ†é¡æ–°èæˆåŠŸï¼Œå…±${data.news.length}æ¢`, true);
                } else {
                    addTestResult(`âŒ è¼‰å…¥ã€Œ${group}ã€åˆ†é¡æ–°èå¤±æ•—`, false);
                }
            } catch (error) {
                addTestResult(`âŒ è¼‰å…¥åˆ†é¡æ–°èå¤±æ•—: ${error.message}`, false);
            } finally {
                document.getElementById('loadingSpinner').classList.add('d-none');
            }
        }
        
        function updateNewsList(newsData, categoryTitle, count) {
            const newsListContainer = document.getElementById('newsList');
            newsListContainer.innerHTML = '';
            
            // æ·»åŠ æ¨™é¡Œ
            const headerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-filter me-2"></i>${categoryTitle}</h5>
                    <span class="badge bg-primary">${count} ç­†çµæœ</span>
                </div>
            `;
            newsListContainer.insertAdjacentHTML('beforeend', headerHTML);
            
            if (!newsData || newsData.length === 0) {
                const noResultsHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">æ­¤åˆ†é¡ä¸­æ²’æœ‰æ–°è</p>
                    </div>
                `;
                newsListContainer.insertAdjacentHTML('beforeend', noResultsHTML);
                return;
            }
            
            newsData.forEach(news => {
                let importanceClass, importanceText, importanceStars;
                if (news.importance_score >= 0.7) {
                    importanceClass = 'bg-danger';
                    importanceText = 'é«˜';
                    importanceStars = 'â˜…â˜…â˜…';
                } else if (news.importance_score >= 0.4) {
                    importanceClass = 'bg-warning text-dark';
                    importanceText = 'ä¸­';
                    importanceStars = 'â˜…â˜…â˜†';
                } else {
                    importanceClass = 'bg-info';
                    importanceText = 'ä½';
                    importanceStars = 'â˜…â˜†â˜†';
                }
                
                const publishDate = new Date(news.published_date).toLocaleDateString('zh-TW');
                
                const newsItemHTML = `
                    <div class="news-item mb-3 p-3 border rounded" data-news-id="${news.id}">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                <input type="checkbox" class="news-select form-check-input" value="${news.id}">
                            </div>
                            <div class="flex-grow-1">
                                <h6>
                                    <span class="importance-star text-warning">${importanceStars}</span>
                                    ${news.title}
                                </h6>
                                <p class="text-muted mb-2">${news.summary}</p>
                                <div>
                                    <span class="badge ${importanceClass}">é‡è¦æ€§ï¼š${importanceText}</span>
                                    <span class="badge bg-secondary">ä¾†æºï¼š${news.source_name}</span>
                                    <span class="badge bg-light text-dark">æ—¥æœŸï¼š${publishDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                newsListContainer.insertAdjacentHTML('beforeend', newsItemHTML);
            });
            
            // æ›´æ–°å…¨é¸åŠŸèƒ½
            const selectAllBtn = document.getElementById('selectAll');
            if (selectAllBtn) {
                selectAllBtn.checked = false;
                selectAllBtn.addEventListener('change', function() {
                    const checkboxes = document.querySelectorAll('.news-select');
                    checkboxes.forEach(cb => cb.checked = this.checked);
                });
            }
        }
    </script>
</body>
</html>
