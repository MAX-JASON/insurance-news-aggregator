{% extends "base.html" %}

{% block title %}{{ news.title }} - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
.business-insights {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
}

.insight-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.importance-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: #ff6b6b;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
}

.business-action-panel {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.quick-share-btn {
    margin: 0.25rem;
    border-radius: 20px;
}

.client-question {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding: 1rem;
    margin: 1rem 0;
    border-radius: 0 8px 8px 0;
}

.opportunity-highlight {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.trend-indicator {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

.trend-up { background: #28a745; color: white; }
.trend-down { background: #dc3545; color: white; }
.trend-stable { background: #6c757d; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- ä¸»è¦å…§å®¹ -->
    <div class="col-lg-8">
        <div class="card position-relative">
            <!-- é‡è¦æ€§æ¨™è¨˜ -->
            <div class="importance-badge">
                {% if news.importance_score and news.importance_score >= 0.8 %}
                    â˜…â˜…â˜… é«˜åº¦é‡è¦
                {% elif news.importance_score and news.importance_score >= 0.5 %}
                    â˜…â˜…â˜† ä¸­åº¦é‡è¦
                {% else %}
                    â˜…â˜†â˜† ä¸€èˆ¬é‡è¦
                {% endif %}
            </div>

            <div class="card-body">
                <h1 class="card-title mb-3">{{ news.title }}</h1>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="badge bg-primary me-2">
                            {{ news.source.name if news.source else 'æœªçŸ¥ä¾†æº' }}
                        </span>
                        <span class="badge bg-secondary me-2">
                            {{ news.category.name if news.category else 'æœªåˆ†é¡' }}
                        </span>
                        {% if news.published_date %}
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>
                            {{ news.published_date.strftime('%Y-%m-%d %H:%M') }}
                        </small>
                        {% endif %}
                    </div>
                    <div>
                        <span class="text-muted">
                            <i class="fas fa-eye me-1"></i>{{ news.view_count or 0 }} æ¬¡ç€è¦½
                        </span>
                    </div>
                </div>

                <!-- æ–°èæ‘˜è¦ -->
                {% if news.summary %}
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>æ–°èæ‘˜è¦</h6>
                    <p class="mb-0">{{ news.summary }}</p>
                </div>
                {% endif %}

                <!-- æ–°èå…§å®¹ -->
                <div class="news-content">
                    {% if news.content %}
                        {{ news.content | safe }}
                    {% else %}
                        <p class="text-muted">æ–°èå…§å®¹æ­£åœ¨è¼‰å…¥ä¸­...</p>
                    {% endif %}
                </div>

                <!-- åŸæ–‡é€£çµ -->
                {% if news.url %}
                <div class="mt-4">
                    <a href="{{ news.url }}" target="_blank" class="btn btn-outline-primary">
                        <i class="fas fa-external-link-alt me-2"></i>æŸ¥çœ‹åŸæ–‡
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- æ¥­å‹™å“¡å·¥å…·å´é‚Šæ¬„ -->
    <div class="col-lg-4">
        <!-- æ¥­å‹™æ´å¯Ÿ -->
        <div class="business-insights">
            <h5><i class="fas fa-lightbulb me-2"></i>æ¥­å‹™æ´å¯Ÿ</h5>
            
            <div class="insight-card">
                <h6><i class="fas fa-users me-2"></i>å®¢æˆ¶é—œæ³¨åº¦</h6>
                <div class="progress mb-2">
                    <div class="progress-bar bg-success" style="width: {{ (news.view_count or 0) * 2 if (news.view_count or 0) < 50 else 100 }}%"></div>
                </div>
                <small>é ä¼° {{ ((news.view_count or 0) * 0.1) | round | int }} ä½å®¢æˆ¶å¯èƒ½è©¢å•</small>
            </div>

            <div class="insight-card">
                <h6><i class="fas fa-coins me-2"></i>å•†æ©Ÿè©•åˆ†</h6>
                {% set opportunity_score = (news.importance_score or 0) * 100 %}
                <div class="d-flex justify-content-between align-items-center">
                    <span class="h4 mb-0">{{ opportunity_score | round | int }}åˆ†</span>
                    {% if opportunity_score >= 70 %}
                        <span class="trend-indicator trend-up">é«˜å•†æ©Ÿ</span>
                    {% elif opportunity_score >= 40 %}
                        <span class="trend-indicator trend-stable">ä¸­å•†æ©Ÿ</span>
                    {% else %}
                        <span class="trend-indicator trend-down">ä½å•†æ©Ÿ</span>
                    {% endif %}
                </div>
            </div>

            <div class="insight-card">
                <h6><i class="fas fa-chart-line me-2"></i>å¸‚å ´å½±éŸ¿</h6>
                <p class="mb-0 small">
                    {% if 'ç†è³ ' in news.title %}
                        å®¢æˆ¶æœå‹™æµç¨‹å¯èƒ½å—å½±éŸ¿ï¼Œå»ºè­°æº–å‚™ç›¸é—œèªªæ˜
                    {% elif 'ä¿è²»' in news.title %}
                        å®šåƒ¹ç­–ç•¥èª¿æ•´ï¼Œå¯èƒ½å½±éŸ¿å•†å“éŠ·å”®
                    {% elif 'æ³•è¦' in news.title %}
                        åˆè¦è¦æ±‚æ›´æ–°ï¼Œéœ€è¦åœ˜éšŠåŸ¹è¨“
                    {% else %}
                        ä¸€èˆ¬å¸‚å ´è³‡è¨Šï¼ŒæŒçºŒé—œæ³¨ç™¼å±•
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- å®¢æˆ¶å¸¸è¦‹å•é¡Œ -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-question-circle me-2"></i>å®¢æˆ¶å¯èƒ½çš„å•é¡Œ</h6>
            </div>
            <div class="card-body">
                <div class="client-question">
                    <strong>Q: é€™å€‹æ–°èå°æˆ‘çš„ä¿å–®æœ‰ä»€éº¼å½±éŸ¿ï¼Ÿ</strong>
                    <p class="mb-0 mt-2 small">
                        {% if 'ç†è³ ' in news.title %}
                            A: æ–°çš„ç†è³ æµç¨‹å°‡è®“æ‚¨çš„ç†è³ ç”³è«‹æ›´ä¾¿æ·ï¼Œæˆ‘å€‘æœƒç‚ºæ‚¨è©³ç´°èªªæ˜æ–°çš„æ“ä½œæ–¹å¼ã€‚
                        {% elif 'ä¿è²»' in news.title %}
                            A: ä¿è²»èª¿æ•´ä¸»è¦åæ˜ é¢¨éšªæˆæœ¬è®ŠåŒ–ï¼Œæˆ‘å€‘æœƒåˆ†æå°æ‚¨å€‹äººä¿å–®çš„å…·é«”å½±éŸ¿ã€‚
                        {% else %}
                            A: æˆ‘æœƒæ ¹æ“šæ‚¨çš„å…·é«”ä¿å–®æƒ…æ³ï¼Œç‚ºæ‚¨åˆ†æé€™é …è®Šå‹•çš„å½±éŸ¿ä¸¦æä¾›å°ˆæ¥­å»ºè­°ã€‚
                        {% endif %}
                    </p>
                </div>
                
                <div class="client-question">
                    <strong>Q: éœ€è¦èª¿æ•´æˆ‘çš„ä¿éšªè¦åŠƒå—ï¼Ÿ</strong>
                    <p class="mb-0 mt-2 small">A: è®“æˆ‘å€‘å®‰æ’æ™‚é–“è©³ç´°åˆ†ææ‚¨ç›®å‰çš„ä¿éšœéœ€æ±‚ï¼Œä¸¦æ ¹æ“šæœ€æ–°æƒ…æ³èª¿æ•´è¦åŠƒå»ºè­°ã€‚</p>
                </div>
            </div>
        </div>

        <!-- ç›¸é—œå•†å“æ¨è–¦ -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>ç›¸é—œå•†å“</h6>
            </div>
            <div class="card-body">
                {% if 'é•·ç…§' in news.title %}
                    <div class="opportunity-highlight">
                        <h6>é•·æœŸç…§è­·ä¿éšª</h6>
                        <p class="small mb-2">æ ¹æ“šæ–°èè¶¨å‹¢ï¼Œé•·ç…§éœ€æ±‚æŒçºŒå¢åŠ </p>
                        <button class="btn btn-sm btn-success">äº†è§£æ–¹æ¡ˆ</button>
                    </div>
                {% elif 'é†«ç™‚' in news.title %}
                    <div class="opportunity-highlight">
                        <h6>é†«ç™‚ä¿éšªå‡ç´š</h6>
                        <p class="small mb-2">é†«ç™‚æŠ€è¡“é€²æ­¥ï¼Œä¿éšœéœ€è¦åŒæ­¥å‡ç´š</p>
                        <button class="btn btn-sm btn-success">äº†è§£æ–¹æ¡ˆ</button>
                    </div>
                {% else %}
                    <div class="opportunity-highlight">
                        <h6>å€‹äººé¢¨éšªåˆ†æ</h6>
                        <p class="small mb-2">æ ¹æ“šæœ€æ–°å¸‚å ´è®ŠåŒ–ï¼Œé‡æ–°æª¢è¦–ä¿éšœéœ€æ±‚</p>
                        <button class="btn btn-sm btn-success">é ç´„è«®è©¢</button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- æ¥­å‹™è¡Œå‹•é¢æ¿ -->
        <div class="business-action-panel">
            <h6><i class="fas fa-tools me-2"></i>æ¥­å‹™å·¥å…·</h6>
            
            <div class="mb-3">
                <label class="form-label small">å¿«é€Ÿåˆ†äº«</label>
                <div>
                    <button class="btn btn-success btn-sm quick-share-btn" onclick="shareToLine()">
                        <i class="fab fa-line me-1"></i>LINE
                    </button>
                    <button class="btn btn-primary btn-sm quick-share-btn" onclick="shareToEmail()">
                        <i class="fas fa-envelope me-1"></i>éƒµä»¶
                    </button>
                    <button class="btn btn-info btn-sm quick-share-btn" onclick="shareToWechat()">
                        <i class="fab fa-weixin me-1"></i>å¾®ä¿¡
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label small">å®¢æˆ¶ç®¡ç†</label>
                <div>
                    <button class="btn btn-warning btn-sm quick-share-btn" onclick="addToFollowUp()">
                        <i class="fas fa-bookmark me-1"></i>åŠ å…¥è¿½è¹¤
                    </button>
                    <button class="btn btn-secondary btn-sm quick-share-btn" onclick="createReminder()">
                        <i class="fas fa-bell me-1"></i>è¨­æé†’
                    </button>
                </div>
            </div>

            <div>
                <label class="form-label small">å ±å‘Šå·¥å…·</label>
                <div>
                    <button class="btn btn-danger btn-sm quick-share-btn" onclick="generatePDF()">
                        <i class="fas fa-file-pdf me-1"></i>PDFæ‘˜è¦
                    </button>
                    <button class="btn btn-dark btn-sm quick-share-btn" onclick="addToReport()">
                        <i class="fas fa-plus me-1"></i>åŠ å…¥é€±å ±
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†äº«æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åˆ†äº«çµ¦å®¢æˆ¶</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">åˆ†äº«æ¨™é¡Œ</label>
                    <input type="text" class="form-control" id="shareTitle" value="ğŸ“° é‡è¦ä¿éšªæ–°è">
                </div>
                <div class="mb-3">
                    <label class="form-label">åˆ†äº«å…§å®¹</label>
                    <textarea class="form-control" id="shareContent" rows="5">{{ news.title }}

{{ news.summary[:100] }}...

å¦‚æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿éš¨æ™‚è¯ç¹«æ‚¨çš„ä¿éšªé¡§å•ã€‚</textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmShare()">ç¢ºèªåˆ†äº«</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSharePlatform = '';

function shareToLine() {
    currentSharePlatform = 'line';
    $('#shareModal').modal('show');
}

function shareToEmail() {
    currentSharePlatform = 'email';
    document.getElementById('shareTitle').value = 'ä¿éšªæ–°èå¿«å ±ï¼š{{ news.title[:30] }}...';
    $('#shareModal').modal('show');
}

function shareToWechat() {
    currentSharePlatform = 'wechat';
    $('#shareModal').modal('show');
}

function confirmShare() {
    const title = document.getElementById('shareTitle').value;
    const content = document.getElementById('shareContent').value;
    
    // é€™è£¡å¯ä»¥æ•´åˆå¯¦éš›çš„åˆ†äº«API
    alert(`å·²æº–å‚™åˆ†äº«åˆ°${currentSharePlatform}:\n\n${title}\n\n${content}`);
    $('#shareModal').modal('hide');
}

function addToFollowUp() {
    // åŠ å…¥è¿½è¹¤æ¸…å–®
    fetch('/business/api/add-follow-up', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            news_id: {{ news.id }},
            title: '{{ news.title }}'
        })
    }).then(response => {
        if (response.ok) {
            alert('å·²åŠ å…¥è¿½è¹¤æ¸…å–®');
        }
    });
}

function createReminder() {
    const reminderDate = prompt('è«‹è¨­å®šæé†’æ—¥æœŸ (YYYY-MM-DD):');
    if (reminderDate) {
        // å‰µå»ºæé†’
        fetch('/business/api/create-reminder', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                news_id: {{ news.id }},
                reminder_date: reminderDate,
                title: '{{ news.title }}'
            })
        }).then(response => {
            if (response.ok) {
                alert('æé†’å·²è¨­å®š');
            }
        });
    }
}

function generatePDF() {
    // ç”ŸæˆPDFæ‘˜è¦
    window.open('/business/tools/pdf-summary/{{ news.id }}', '_blank');
}

function addToReport() {
    // åŠ å…¥é€±å ±
    fetch('/business/api/add-to-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            news_id: {{ news.id }},
            title: '{{ news.title }}'
        })
    }).then(response => {
        if (response.ok) {
            alert('å·²åŠ å…¥é€±å ±');
        }
    });
}

// å¢åŠ ç€è¦½æ¬¡æ•¸
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/v1/news/{{ news.id }}/view', { method: 'POST' });
});
</script>
{% endblock %}
